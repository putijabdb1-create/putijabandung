<script>
/* ========== KONFIG ========== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzfYMYq83BYCNxITAK-CbGQ0uA5diRWuFw1-kyd7zzqmcFR_3hwWnHtNNDLTF4mUHc/exec";
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1uACE2nd-2E8CNtG-nQUiTUd4x5C2sFfKdZJeb1D_sbM/edit?gid=0#gid=0";
const DRIVE_FOLDER_URL = "https://drive.google.com/drive/folders/1xW5TQYUgpHRbFTdL8nFIxAQA9aJfP7uK?usp=drive_link";
const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5 MB

/* ========== USER LIST (paste seperti milikmu) ========== */
const USER_LINES = [
  "PTJ_Arip007|alvaro007|15889311|ARIP RAHMATULLOH|PIC|CMI",
  "PTJ_15889310|30223023|15889310|UUS SETIADI|PIC|BTJ",
  "PTJ_Bob1990|TE1990|BELUM ADA|ASEP SAEPUDIN|PIC|CMI",
  "PTJ_Du2ng|Aisha221011|BELUM ADA|DUDUNG SUKMANA|PIC|CMI",
  "PTJ_Endi1994|Ardila06@@|15889307|ENDI HENDRIANA|PIC|CMI",
  "PTJ_FirmanFirdaus013|FirmanFirdaus013|16990042|MUHAMMAD FIRMAN DAUD FIRDAUS|PIC|CMI",
  "PTJ_Vikri012|Vikri0012|BELUM ADA|VIKRI FADHI RAHMAN|PIC|BTJ",
  "PTJ_Agus25|Ajiz1989|16891202|AGUS|IOAN|NJG",
  "PTJ_Alfian07|Fianape7|16004674|ALFIAN PERMADI HERDIANSYAH|IOAN|CMI",
  "PTJ_Anggi13|Zhafran02|15892036|ANGGI SETIAWAN|IOAN|BTJ",
  "PTJ_Asep125|4sep5ule|15889318|ASEP SULAEMAN|IOAN|NJG",
  "PTJ_Asep006|Bacilu01|15889328|ASEP SUTARYAT|IOAN|BTJ",
  "PTJ_Mardian67|Mardian67|16012066|DANDI MARDIANSYAH|IOAN|GNH",
  "PTJ_Deni017|Denok017|16050949|DENI EGI SAPUTRA|IOAN|CMI",
  "PTJ_Deni699|Deni@699|16850259|DENI WARDANI|IOAN|BTJ",
  "PTJ_Deniec15889321|Nanjung2025|15889321|DENIEC GORO SULISTYANTO|IOAN|NJG",
  "PTJ_DODIMARDANI004|Putija004|15889324|DODI MARDANI|IOAN|CLL",
  "PTJ_Engkos270|Kostaman80|15889334|ENGKOS KOSTAMAN|IOAN|NJG",
  "PTJ_Fakhri95|Fakhr1995|15889339|FAKHRI RASYAD RAMDHANI|IOAN|CMI",
  "PTJ_Giant77|Telkom77|15889330|GIAN KRISTAL|IOAN|NJG",
  "PTJ_INDRA999|270310Aa|16921681|INDRA PRATAMA|IOAN|NJG",
  "PTJ_Nugraha24|Street24|15882130|INSAN NUGRAHA|IOAN|CMI",
  "PTJ_Irfanm019|putija@1|16950710|IRFAN MAULANA|IOAN|CMI",
  "PTJ_Irfan16022301|Bacilu01|16022301|IRFAN NURJAMAN|IOAN|BTJ",
  "PTJ_Juli86|juli0786|15889309|JULI SURYANA|IOAN|NJG",
  "PTJ_Nazli313|arkan2015|15889313|NAZLI RUDI YANTO|IOAN|CMI",
  "PTJ_Rendyherwansyah|putija@2025|15902465|RENDI HERWANSYAH|IOAN|GNH",
  "PTJ_Galing28|galing2810|15901086|RIDWAN RISWANDI|IOAN|NJG",
  "PTJ_Sahibul87|ahyad87|15889319|SAHIBUL AHYAD|IOAN|CMI",
  "PTJ_Taryana2004|atar2004|15889316|TARYANA|IOAN|CMI",
  "PTJ_TAUFIK046|PUTIJA046|15889345|TAUFIK HIDAYAT|IOAN|NJG",
  "PTJ_Tisna05|241103rm|15889326|TISNA|IOAN|BTJ",
  "PTJ_Ujang77|uchin2877|15889333|UJANG MUKSIN|IOAN|CMI",
  "PTJ_Yogi28|Yogi2828|16950715|YOGI TJANDRA FERNANDO|IOAN|CMI",
  "PTJ_YUNUS696|Absen696|15900696|YUNUS HITOTUN|IOAN|CMI",
  "PTJ_Aditya129|aditya0707|BELUM ADA|ADITYA RAMDAN SYARIF|PSB|BTJ",
  "PTJ_Yusup16942254|putija@2028|16942254|AHMAD MAULANA YUSUP|PSB|BTJ",
  "PTJ_Ahmad29040|zaki290406|BELUM ADA|AHMAD ZAQI|PSB|CMI",
  "PTJ_Andi027|mspeed27|16952753|ANDI RAMDANI|PSB|CMI",
  "PTJ_ANDIAN666|123Asik#|BELUM ADA|ANDIAN WAHYUDI|PSB|CLL",
  "PTJ_Ardian17|deci12345|BELUM ADA|ARDIAN HAFIDZ|PSB|BTJ",
  "PTJ_Arga003|Arga1603|16901188|ARGA ALI SANTIAJI|PSB|NJG",
  "PTJ_Aria015|Aria2025|16911316|ARIA RIDWANTO|PSB|CLL",
  "PTJ_Asep0797|Telkom0797|16974185|ASEP SAEPUL HIDAYAT|PSB|GNH",
  "PTJ_Dedi08|RizkiRizam12|16820493|DEDI WINARDI|PSB|NJG",
  "PTJ_Enjang93|Hardi1993|16931851|ENJANG HARDI|PSB|CMI",
  "PTJ_Febby90|putija25|16901210|FEBBY REZA NURHUDA|PSB|CLL",
  "PTJ_IbnuDcs|Kududiuye|16022542|IBNU DZAHABI|PSB|CMI",
  "PTJ_Bowo182|makemanah85|16850029|KHOERUDIN PRABOWO|PSB|CMI",
  "PTJ_Ilyas1289|Rilkay2018|15891521|KM ILYAS AKBAR|PSB|NJG",
  "PTJ_PadiiiL7|padilada22|BELUM ADA|LUTFHIAN ALFADHILA SURYANA|PSB|CMI",
  "PTJ_Mahpud0611|rendekidul01|16022545|MAHPUD SOPIAN|PSB|CMI",
  "PTJ_MARTONO13|INDONESIA#2024|16004766|MARTONO|PSB|CMI",
  "PTJ_MASKUR13|Maskur130700|16002023|MASKUR|PSB|CLL",
  "PTJ_rifan07|cimahicity5|Belum Ada|MOCH RIFAN FAKHRIZAL|PSB|CMI",
  "PTJ_Hasan001|Hasan123|BELUM ADA|MUHAMMAD HASAN|PSB|CMI",
  "PTJ_Imam202002|Ghozali2002|16022546|MUHAMMAD IMAM GHOZALI|PSB|CLL",
  "PTJ_NRyadi33|Nryadi0303|16995419|NURYADI|PSB|NJG",
  "PTJ_Purnama07|Purnama76|BELUM ADA|PURNAMA RAMDANI|PSB|CLL",
  "PTJ_Resky022|Telkom2296|16963327|RESKY ARDIANSYAH|PSB|CMI",
  "PTJ_rmaulana952|bedahciwok001|16953587|RIZWAN MAULANA|PSB|BTJ",
  "PTJ_Sandi014|sandiwah45|BELUM ADA|SANDI WAHYUDI|PSB|BTJ",
  "PTJ_Sanji017|qweasd123|BELUM ADA|SANJI|PSB|CMI",
  "PTJ_Sarijan01|Sarijan12|16901534|SARIJAN|PSB|CLL",
  "PTJ_SOLIHIN1933|PERSIB1933|16942904|SOLIHIN|PSB|GNH",
  "PTJ_Syamsul382|BantuFO38|16022056|SYAMSUL BAHRI|PSB|CMI",
  "PTJ_Tubagus13|Tubagus13|16963926|TUBAGUS BUKIYANTORO|PSB|BTJ",
  "PTJ_Ujang9933|Almera0607|Belum ada|UJANG ROHIMAT|PSB|BTJ",
  "PTJ_BILAL23|bilal1234|16994703|BILAL FISSABILILLAH|PSB|BTJ",
  "PTJ_Robi1121|slipknot.1960|BELUM ADA|AZIS ROBIANSYAH|PSB|CLL",
  "PTJ_@PilihanHelaWeh|16870758|16870758|UJANG SUMPENA|PSB|CMI",
  "PTJ_Zacky123|Kadungora05|BELUM ADA|MOCH ZACKY AZKARI|PSB|BTJ",
  "PTJ_Ryanfir72|ryanfi72|BELUM ADA|RIYAN FIRMANSAH|PSB|CMI",
  "PTJ_Alva30|Sunang30|16991540|MUHAMMAD ALVA RIZKY|IOAN|CMI",
  "PTJ_Dikiw15|Dikiw12345|BELUM ADA|DIKI WAHYUDI SETIAWAN|PSB|CLL",
  "PTJ_Hermawan19|persija19|BELUM ADA|HERMAWAN|PSB|CLL",
  "PTJ_rasyid2007|satusampai9|BELUM ADA|ABDUL RASYID AHMADI RAZZAQ|PSB|NJG",
  "PTJ_Hendra303|PTJ_Hendra303|15889332|HENDRA PERMANA|IOAN|NJG",
  "PTJ_Heri2025|cimahi2025|16770224|HERI NURDIANA SANTOSA|PSB|NJG",
  "PTJ_WAHENDRA|Project01|BELUM ADA|WAHENDRA|PIC|CMI",
  "PTJ_ADI SOPIAN|Project01|15889303|ADI SOPIAN|PIC|CMI",
  "PTJ_Dicky029|Dicky029|16974122|DICKY IRAWAN SONJAYA|PSB|CMI",
  "PTJ_GAGAN SUHERMAN|Project01|BELUM ADA|GAGAN SUHERMAN|PROJEK|CMI",
  "PTJ_DEDE YUSUP|Project01|BELUM ADA|DEDE YUSUP|PROJEK|BTJ",
  "PTJ_RAIHAN|Project01|BELUM ADA|MOCHAMAD RAIHAN ARYA AGUNG|PROJEK|BTJ",
  "PTJ_RESTU|Project01|BELUM ADA|RESTU|PROJEK|CMI",
  "PTJ_RIFKI|Project01|BELUM ADA|RIFKI|PROJEK|CMI",
  "PTJ_Ambar71R|Rawing71|15889320|AMBARYADI GUNAWAN|PSB|NJG",
  "PTJ_AGUNGINDRA014|agungindra041498|16982268|AGUNG INDRA LESMANA|PSB|BTJ",
  "PTJ_bilalfajri27|bilalfajri2005|belum ada|MUHAMAD BILAL FAJRI|PSB|CMI",
  "PTJ_Pentingberkah|Ganjar83|15889317|GANJAR SAEPUDIN|IOAN|CMI",
  "PTJ_ADE22|layadmos2312|16002299|ADE SOPIYAN|IOAN|KNG",
  "PTJ_Nana007|tamanana6661|16022091|NANA ADITAMA|IOAN|KNG",
  "PTJ_Zul78|Aqi11aram|16780156|ZULHAM EFFENDI ZAS|PSB|NJG",
  "PTJ_Opi012|Toren1234|16942370|OPIK IRAWAN|IOAN|KNG",
  "PTJ_Refli012|Putija@12|16023016|REFLI PITDATULLOH|PSB|CMI",
  "PTJ_Puad98|Telkom123|16983641|PUAD TOHAWI|PSB|CLL",
  "PTJ_Pathudin013|Azalea13|16962281|Pathudin|IOAN|KNG",
  "PTJ_Azmi15|Telkom123|16962282|Azmi rifai|IOAN|KNG",
  "PTJ_ErikoRamdani001|Telkom123|BELUM ADA|ERICO RAMDANI|PSB|CLL",
  "PTJ_Febri24|Annuaink100|16900564|FEBRI RIYANDI|IOAN|KNG",
  "PTJ_Ari0079|11223344|16050178|ARI ANGGARA|IOAN|KNG",
  "PTJ_Zahdan17|461147zz|16800322|AGUS SAHDAN|IOAN|KNG",
  "PTJ_DANI001|PTJKNG001|16022092|MUHAMAD RAMDANI|PSB|KNG",
  "PTJ_IMAM001|PTJKNG001|16901520|MOCHAMMAD IMAM TAOFIK|PSB|KNG",
  "PTJ_IPAN001|PTJKNG001|16050679|IPAN GILANG RAMADAN|PSB|KNG",
  "PTJ_RAFI001|PTJKNG001|16050313|RAFI ARIEL NUGRAHA|PSB|KNG",
  "PTJ_SECHAN001|PTJKNG001|16040915|SECHAN BUKHORI|PSB|KNG",
  "PTJ_AGUS001|PTJKNG001|16031512|AGUS HAMDANI|PSB|KNG",
  "PTJ_BAGUS001|PTJKNG001|16003512|BAGUS PRASETIO|PSB|KNG",
  "PTJ_FAHRY001|PTJKNG001|Belum Ada|FAHRY ADITYA ASRIZAL|PSB|KNG",
  "PTJ_DADI001|PTJKNG001|16952927|DADI APRIADI|PSB|KNG",
  "PTJ_IRFAN001|PTJKNG001|16060537|MOHAMMAD IRFAN HAKIM|PSB|KNG",
  "PTJ_SYAHRUL001|PTJKNG001|16050886|SYAHRUL RAMDHAN AT'THORIQ|PSB|KNG",
  "PTJ_DONI001|PTJKNG001|16974498|MUHAMAD RAMDONI|PSB|KNG",
  "PTJ_APRI001|PTJKNG001|Belum Ada|A CANDRA KOSWARA|PROJEK|KNG",
  "PTJ_AZHAR001|PTJKNG001|16973839|M. CHOIRUL AZHARI ROSID|PIC|KNG",
  "PTJ_DADINUR001|PTJKNG001|16890989|DADI NURYADI|PIC|KNG",
  "PTJ_Dendi@01|1052002|BELUM ADA|DENDI MANDIRI|PSB|BTJ",
  "PTJ_Miky11|Saya171194|16942855|MICKY MARDIANA|IOAN|KNG",
  "PTJ_Taufik024|Kuningan24|15893582|TAUFIK AKBAR|IOAN|KNG",
  "PTJ_ZEMMY|putija2025|BELUM ADA|ZEEMY|PIC|CMI",
  "PTJ_DANI|Project01|16850676|DANI|PROJEK|CMI",
  "PTJ_ADITTIYA08|80621|16013886|ADITTIYA HERDI|PSB|CMI"
  // kalau ada lagi, tambahkan di sini
];

/* ========== BUILD USERS ========== */
let USERS = [];
USER_LINES.forEach(line => {
  const [username,password,nik,nama,divisi,defaultArea] = line.split("|");
  USERS.push({username,password,nik,nama,divisi,defaultArea});
});

/* ========== STATE ========== */
let currentUser = null;
let fotoDataUrl = "";
let fotoKtpDataUrl = "";
let fotoKkDataUrl = "";
let fotoNpwpDataUrl = "";
let fotoBpjsKetDataUrl = "";
let fotoBpjsKesDataUrl = "";

/* set admin links */
(function setAdminLinks(){
  const s = document.getElementById("sheetLink");
  const d = document.getElementById("driveLink");
  if (s) s.href = SHEET_URL;
  if (d) d.href = DRIVE_FOLDER_URL;
})();

/* helper normalisasi username */
function norm(u){ return (u||"").toString().trim().toLowerCase(); }

/* ========== LOGIN / AUTOFILL ========= */
function loginTeknisi() {
  const rawId = document.getElementById("loginUser").value.trim();
  const pass  = document.getElementById("loginPass").value.trim();
  const statusEl = document.getElementById("loginStatus");

  const user = USERS.find(u => norm(u.username) === norm(rawId) && u.password === pass);
  if (!user) {
    statusEl.textContent = "Login gagal: user ID atau password salah.";
    statusEl.style.color = "#fca5a5";
    return;
  }

  currentUser = user;
  statusEl.textContent = "Login berhasil sebagai " + user.nama + ". Memuat data...";
  statusEl.style.color = "#bbf7d0";

  document.getElementById("namaPegawai").value = user.nama || "";
  document.getElementById("divisi").value = user.divisi || "";
  document.getElementById("lokasiKerja").value = user.defaultArea || "";

  document.getElementById("formCard").style.display = "block";
  document.getElementById("formCard").scrollIntoView({behavior:"smooth"});

  fetchExistingBiodata(norm(user.username));
}

function logoutTeknisi() {
  currentUser = null;
  document.getElementById("loginUser").value = "";
  document.getElementById("loginPass").value = "";
  const ls = document.getElementById("loginStatus");
  const fs = document.getElementById("formStatus");
  if (ls) { ls.textContent = ""; ls.style.color = ""; }
  if (fs) { fs.textContent = ""; fs.style.color = ""; }
  document.getElementById("formCard").style.display = "none";
  document.getElementById("previewWrapper").style.display = "none";
  clearPreviewAndData();
}

function scrollToForm() {
  document.getElementById("formCard").scrollIntoView({behavior:"smooth"});
}

/* Enter key untuk login */
document.getElementById("loginUser").addEventListener("keydown", e => { if (e.key === "Enter") loginTeknisi(); });
document.getElementById("loginPass").addEventListener("keydown", e => { if (e.key === "Enter") loginTeknisi(); });

/* ========== FILE PREVIEW UTILITY (dengan size check) ========== */
function attachFilePreview(inputId, imgId, setter) {
  const input = document.getElementById(inputId);
  const img   = document.getElementById(imgId);
  if (!input || !img) return;

  input.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > MAX_FILE_BYTES) {
      alert("File terlalu besar (>5MB). Pilih file lebih kecil atau kompres gambar.");
      input.value = "";
      return;
    }
    const reader = new FileReader();
    reader.onerror = () => {
      console.error("Gagal membaca file:", file);
      alert("Gagal membaca file. Coba ulangi.");
    };
    reader.onload = ev => {
      try {
        const url = ev.target.result;
        setter(url);
        img.src = url;
        img.style.display = "block";
      } catch (err) {
        console.error("Error saat memproses file:", err);
      }
    };
    reader.readAsDataURL(file);
  });

  img.addEventListener("click", () => {
    if (!confirm("Hapus gambar ini dari form?")) return;
    input.value = "";
    img.removeAttribute("src");
    img.style.display = "none";
    setter("");
  });
}

attachFilePreview("fotoTeknisi", "previewFotoForm", url => fotoDataUrl = url);
attachFilePreview("fotoKtp", "previewFotoKtp", url => fotoKtpDataUrl = url);
attachFilePreview("fotoKk", "previewFotoKk", url => fotoKkDataUrl = url);
attachFilePreview("fotoNpwp", "previewFotoNpwp", url => fotoNpwpDataUrl = url);
attachFilePreview("fotoBpjsKet", "previewFotoBpjsKet", url => fotoBpjsKetDataUrl = url);
attachFilePreview("fotoBpjsKes", "previewFotoBpjsKes", url => fotoBpjsKesDataUrl = url);

function clearPreviewAndData() {
  fotoDataUrl = fotoKtpDataUrl = fotoKkDataUrl = fotoNpwpDataUrl = fotoBpjsKetDataUrl = fotoBpjsKesDataUrl = "";
  const previews = ["previewFotoForm","previewFotoKtp","previewFotoKk","previewFotoNpwp","previewFotoBpjsKet","previewFotoBpjsKes"];
  previews.forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.removeAttribute("src"); el.style.display = "none"; }
  });
}

/* ========== FETCH EXISTING BIODATA (after login) ========= */
async function fetchExistingBiodata(usernameNorm) {
  const statusEl = document.getElementById("loginStatus");
  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ mode: "getBiodata", username: usernameNorm })
    });
    const j = await res.json();
    if (!j.ok) {
      statusEl.textContent = "Tidak dapat mengambil biodata: " + (j.error || "unknown");
      statusEl.style.color = "#fca5a5";
      return;
    }
    if (!j.found) {
      statusEl.textContent = "Login berhasil â€” biodata belum ada, silakan isi.";
      statusEl.style.color = "#bbf7d0";
      return;
    }

    const b = j.biodata || {};
    const photos = j.photos || {};

    Object.keys(b).forEach(k => {
      const el = document.getElementById(k);
      if (el) el.value = b[k] || "";
    });

    if (photos.fotoTeknisi) { document.getElementById("previewFotoForm").src = photos.fotoTeknisi; document.getElementById("previewFotoForm").style.display = "block"; fotoDataUrl = ""; }
    if (photos.fotoKtp)     { document.getElementById("previewFotoKtp").src = photos.fotoKtp; document.getElementById("previewFotoKtp").style.display = "block"; fotoKtpDataUrl = ""; }
    if (photos.fotoKk)      { document.getElementById("previewFotoKk").src = photos.fotoKk; document.getElementById("previewFotoKk").style.display = "block"; fotoKkDataUrl = ""; }
    if (photos.fotoNpwp)    { document.getElementById("previewFotoNpwp").src = photos.fotoNpwp; document.getElementById("previewFotoNpwp").style.display = "block"; fotoNpwpDataUrl = ""; }
    if (photos.fotoBpjsKet) { document.getElementById("previewFotoBpjsKet").src = photos.fotoBpjsKet; document.getElementById("previewFotoBpjsKet").style.display = "block"; fotoBpjsKetDataUrl = ""; }
    if (photos.fotoBpjsKes) { document.getElementById("previewFotoBpjsKes").src = photos.fotoBpjsKes; document.getElementById("previewFotoBpjsKes").style.display = "block"; fotoBpjsKesDataUrl = ""; }

    statusEl.textContent = "Biodata ditemukan & dimuat. Anda dapat mengedit lalu Simpan.";
    statusEl.style.color = "#bbf7d0";
  } catch (err) {
    statusEl.textContent = "Gagal mengambil biodata: " + err.message;
    statusEl.style.color = "#fca5a5";
    console.error("fetchExistingBiodata error:", err);
  }
}

/* ========== COLLECT DATA & SAVE ========== */
function collectFormData() {
  const get = id => document.getElementById(id)?.value || "";
  return {
    namaPegawai: get("namaPegawai"),
    ttl: get("ttl"),
    jenisKelamin: get("jenisKelamin"),
    pendidikanAkhir: get("pendidikanAkhir"),
    pendFormal: get("pendFormal"),
    pendNonFormal: get("pendNonFormal"),
    statusPerkawinan: get("statusPerkawinan"),
    lokasiKerja: get("lokasiKerja"),
    posisiKerja: get("posisiKerja"),
    divisi: get("divisi"),
    alamatDomisili: get("alamatDomisili"),
    domKel: get("domKel"),
    domKec: get("domKec"),
    domKota: get("domKota"),
    noHp: get("noHp"),
    email: get("email"),
    noKtp: get("noKtp"),
    noNpwp: get("noNpwp"),
    namaIbu: get("namaIbu"),
    noRekening: get("noRekening"),
    namaBank: get("namaBank"),
    ktpAlamat: get("ktpAlamat"),
    ktpKel: get("ktpKel"),
    ktpKec: get("ktpKec"),
    ktpKota: get("ktpKota"),
    bpjsKet: get("bpjsKet"),
    bpjsKes: get("bpjsKes"),
    namaPasangan: get("namaPasangan"),
    bpjsPasangan: get("bpjsPasangan"),
    telpKerabat: get("telpKerabat"),
    dataAnak: get("dataAnak"),
    namaFaskes: get("namaFaskes"),
    noKk: get("noKk")
  };
}

async function saveBiodata() {
  if (!currentUser) { alert("Silakan login terlebih dahulu."); return; }
  const statusEl = document.getElementById("formStatus");
  statusEl.style.color = "#9ca3af";
  statusEl.textContent = "Menyimpan biodata ke Google Sheet...";

  const data = collectFormData();

  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        mode: "saveBiodata",
        user: { username: norm(currentUser.username), nik: currentUser.nik, nama: currentUser.nama },
        biodata: data,
        foto: fotoDataUrl,
        fotoKtp: fotoKtpDataUrl,
        fotoKk: fotoKkDataUrl,
        fotoNpwp: fotoNpwpDataUrl,
        fotoBpjsKet: fotoBpjsKetDataUrl,
        fotoBpjsKes: fotoBpjsKesDataUrl
      })
    });
    const j = await res.json();
    if (!j.ok) {
      statusEl.style.color = "#fca5a5";
      statusEl.textContent = "Gagal: " + (j.error || "unknown");
      console.error("saveBiodata fail:", j);
      return;
    }

    statusEl.style.color = "#bbf7d0";
    statusEl.textContent = "Biodata tersimpan (" + j.action + ").";
    console.log("save response:", j);

    if (j.photos) {
      const urls = Object.values(j.photos).filter(Boolean);
      if (urls.length) {
        statusEl.textContent += " Foto tersimpan.";
        console.log("Foto URLs:", j.photos);
      }
    }

    fetchExistingBiodata(norm(currentUser.username));
  } catch (err) {
    statusEl.style.color = "#fca5a5";
    statusEl.textContent = "Gagal menyimpan biodata: " + err.message;
    console.error("Error fetch:", err);
  }
}

/* ========== PREVIEW CETAK ========== */
function isiText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val || "-";
}
function setImgSrc(id, url) {
  const el = document.getElementById(id);
  if (!el) return;
  if (url) el.src = url;
  else el.removeAttribute("src");
}

function showPreviewBiodata() {
  const data = collectFormData();

  isiText("pvNamaPegawai", data.namaPegawai);
  isiText("pvTtl", data.ttl);
  isiText("pvJenisKelamin", data.jenisKelamin);
  isiText("pvPendidikanAkhir", data.pendidikanAkhir);
  isiText("pvPendidikanFormal", data.pendFormal);
  isiText("pvPendidikanNonFormal", data.pendNonFormal);

  isiText("pvStatusPerkawinan", data.statusPerkawinan);
  isiText("pvLokasiKerja", data.lokasiKerja);
  isiText("pvPosisiKerja", data.posisiKerja);
  isiText("pvDivisi", data.divisi);

  isiText("pvAlamatDomisili", data.alamatDomisili);
  isiText("pvDomKel", data.domKel);
  isiText("pvDomKec", data.domKec);
  isiText("pvDomKota", data.domKota);

  isiText("pvNoHp", data.noHp);
  isiText("pvEmail", data.email);
  isiText("pvNoKtp", data.noKtp);
  isiText("pvNoNpwp", data.noNpwp);
  isiText("pvNamaIbu", data.namaIbu);
  isiText("pvNoRekening", data.noRekening);
  isiText("pvNamaBank", data.namaBank);

  isiText("pvKtpAlamat", data.ktpAlamat);
  isiText("pvKtpKel", data.ktpKel);
  isiText("pvKtpKec", data.ktpKec);
  isiText("pvKtpKota", data.ktpKota);

  isiText("pvBpjsKet", data.bpjsKet);
  isiText("pvBpjsKes", data.bpjsKes);
  isiText("pvNamaPasangan", data.namaPasangan);
  isiText("pvBpjsPasangan", data.bpjsPasangan);
  isiText("pvTelpKerabat", data.telpKerabat);
  isiText("pvDataAnak", data.dataAnak);
  isiText("pvNamaFaskes", data.namaFaskes);
  isiText("pvNoKk", data.noKk);

  setImgSrc("bioFotoInline", fotoDataUrl || document.getElementById("previewFotoForm")?.src);
  setImgSrc("bioFotoKtp", fotoKtpDataUrl || document.getElementById("previewFotoKtp")?.src);
  setImgSrc("bioFotoNpwp", fotoNpwpDataUrl || document.getElementById("previewFotoNpwp")?.src);
  setImgSrc("bioFotoBpjsKet", fotoBpjsKetDataUrl || document.getElementById("previewFotoBpjsKet")?.src);
  setImgSrc("bioFotoBpjsKes", fotoBpjsKesDataUrl || document.getElementById("previewFotoBpjsKes")?.src);
  setImgSrc("bioFotoKk", fotoKkDataUrl || document.getElementById("previewFotoKk")?.src);

  document.getElementById("pvPrintedAt").textContent =
    new Date().toLocaleString("id-ID", {dateStyle:"short", timeStyle:"short"});

  const wrapper = document.getElementById("previewWrapper");
  wrapper.style.display = "block";
  wrapper.scrollIntoView({behavior:"smooth"});
}
</script>
