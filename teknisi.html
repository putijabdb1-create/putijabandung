<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Login Teknisi ‚Äì PT PUTRA TIMUR JAYA BDB1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Poppins", sans-serif;
      background: radial-gradient(circle at top left, #22c55e22, transparent 50%),
                  radial-gradient(circle at bottom right, #4f46e522, transparent 55%),
                  linear-gradient(135deg, #020617, #020617 40%, #020617);
      color: #f9fafb;
      min-height: 100vh;
    }
    a { text-decoration: none; color: inherit; }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 18px 40px;
    }

    .navbar {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(20px);
      background: linear-gradient(to right, #020617cc, #020617dd);
      border-bottom: 1px solid #1f2937;
    }
    .nav-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 10px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-brand { display:flex; align-items:center; gap:10px; }
    .nav-brand-logo { width:30px; height:30px; border-radius:999px; background:radial-gradient(circle,#4ade80,#22c55e); display:flex; align-items:center; justify-content:center; color:#022c22; font-weight:700; }
    .nav-brand-title { display:flex; flex-direction:column; }
    .nav-brand-title span:first-child { font-size:11px; letter-spacing:0.16em; text-transform:uppercase; color:#9ca3af; }
    .nav-brand-title span:last-child { font-size:13px; font-weight:600; }
    .nav-links { list-style:none; display:flex; gap:14px; font-size:13px; }
    .nav-links a { padding:6px 12px; border-radius:999px; color:#e5e7eb; transition: background .18s, transform .15s; }
    .nav-links a:hover { background:#2563eb; color:#f9fafb; transform:translateY(-1px); }
    .nav-links a.active { background:#2563eb; color:#f9fafb; }

    .grid-2 { display:grid; grid-template-columns: minmax(0,0.9fr) minmax(0,1.4fr); gap:20px; margin-top:26px; }
    @media(max-width:900px){ .grid-2 { grid-template-columns:1fr } }

    .card { background:#020617; border-radius:18px; padding:18px; border:1px solid #1f2937; box-shadow:0 16px 45px rgba(15,23,42,0.85); }
    .login-card{ position:relative }
    .form-card{ border-color:#334155 }
    .card h2{ font-size:16px; margin-bottom:6px }
    .card small{ font-size:11px; color:#9ca3af }

    label{ font-size:12px; display:block; margin-bottom:4px; color:#e5e7eb }
    input, select, textarea { width:100%; padding:8px 10px; border-radius:10px; border:1px solid #374151; background:#020617; color:#f9fafb; font-size:12px; outline:none; margin-bottom:8px; }
    input:focus, select:focus, textarea:focus { border-color:#2563eb; box-shadow:0 0 0 1px #2563eb55; }
    textarea{ min-height:60px; resize:vertical; }

    .btn{ padding:8px 14px; border-radius:999px; font-size:12px; font-weight:600; cursor:pointer; display:inline-flex; gap:6px; align-items:center; }
    .btn-primary{ background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#f9fafb; box-shadow:0 14px 30px rgba(37,99,235,0.55) }
    .btn-secondary{ background:transparent; color:#e5e7eb; border:1px solid #4b5563 }
    .btn-danger{ background:#dc2626; color:#f9fafb }
    .btn-group{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }

    .field-row-2 { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
    @media(max-width:600px){ .field-row-2 { grid-template-columns:1fr } }

    .section-title { font-size:13px; font-weight:600; margin-top:16px; margin-bottom:6px; border-bottom:1px solid #1f2937; padding-bottom:2px; }
    .status-text { margin-top:8px; font-size:11px; color:#9ca3af }

    img.preview-small { margin-top:6px; max-width:120px; border-radius:10px; display:none; border:1px solid #1f2937; }

    /* Preview A4 */
    .biodata-wrapper { margin-top:32px; }
    .biodata-page { width:210mm; min-height:297mm; margin:0 auto; padding:18mm 20mm; background:#fff; color:#000; box-shadow:0 10px 30px rgba(0,0,0,0.25); position:relative; font-size:11px; line-height:1.4; }
    .biodata-header { text-align:center; margin-bottom:10px }
    .bio-section { margin-top:14px }
    .bio-section-title { font-weight:700; font-size:11px; text-transform:uppercase; margin-bottom:4px; border-bottom:1px solid #000; padding-bottom:2px; }
    .bio-table { width:100%; border-collapse:collapse; margin-top:4px; font-size:11px; }
    .bio-table td { border:1px solid #00000033; padding:3px 6px; vertical-align:top; }
    .bio-table td.label { width:35%; font-weight:500 }
    .bio-table td.value { width:65% }
    .bio-table img { max-width:30mm; max-height:40mm; object-fit:cover; border:1px solid #00000088; }
    .biodata-photo-box { position:absolute; top:20mm; right:22mm; width:32mm; height:42mm; border:1px solid #000; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .biodata-photo-box img { width:100%; height:100%; object-fit:cover; }

    @media print {
      body { background:#fff !important }
      .navbar, .page { box-shadow:none !important; background:#fff !important }
      .card { box-shadow:none !important; background:#fff !important; border:none !important }
      .biodata-page { box-shadow:none; margin:0; width:auto; min-height:auto; padding:10mm 12mm }
      #previewWrapper { margin:0 }
      .btn, .login-card, .form-card { display:none !important }
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="nav-inner">
      <div class="nav-brand">
        <div class="nav-brand-logo">P</div>
        <div class="nav-brand-title">
          <span>PT PUTRA TIMUR JAYA</span>
          <span>BANDUNG BARAT 1</span>
        </div>
      </div>
      <ul class="nav-links">
        <li><a href="index.html">Beranda</a></li>
        <li><a href="program.html">Program</a></li>
        <li><a href="galeri.html">Galeri</a></li>
        <li><a href="teknisi.html" class="active">Login Teknisi</a></li>
        <li><a href="kontak.html">Kontak</a></li>
      </ul>
    </div>
  </header>

  <main class="page">
    <h1 style="font-size:18px;font-weight:600;">Login Teknisi</h1>
    <p style="font-size:12px;color:#9ca3af;margin-top:4px;">
      Halaman khusus untuk teknisi PT PUTRA TIMUR JAYA BDB1. Teknisi harus login terlebih dahulu sebelum mengisi biodata.
    </p>

    <div class="grid-2">
      <!-- LOGIN -->
      <div class="card login-card">
        <h2>Login Teknisi</h2>
        <small>Gunakan user &amp; password yang sama dengan aplikasi absensi teknisi.</small>

        <div style="margin-top:12px;">
          <label for="loginUser">User ID</label>
          <input id="loginUser" placeholder="Contoh: PTJ_Arip007" />

          <label for="loginPass">Password</label>
          <input id="loginPass" type="password" placeholder="Password" />

          <div class="btn-group" style="margin-top:10px;">
            <button class="btn btn-primary" type="button" onclick="loginTeknisi()">üîë Login</button>
            <a class="btn btn-secondary" href="https://putijabdb1-create.github.io/Absen-ptptjbdb1/" target="_blank">üîó Buka Halaman Absensi</a>
          </div>

          <p class="status-text">
            *Data user diambil dari daftar user absensi (USER_LINES) di bawah. Jika ada teknisi baru,
            cukup tambah di daftar user.
          </p>

          <p id="loginStatus" class="status-text"></p>
        </div>
      </div>

      <!-- FORM BIODATA -->
      <div class="card form-card" id="formCard" style="display:none;">
        <h2>Form Biodata Teknisi</h2>
        <small>Data berikut diisi oleh teknisi. Hasilnya akan dikirim ke Google Sheet &amp; bisa dicetak sebagai biodata pegawai.</small>

        <div style="margin-top:12px;">
          <div class="section-title">Data Pribadi</div>

          <label for="namaPegawai">Nama Pegawai</label>
          <input id="namaPegawai" />

          <div class="field-row-2">
            <div>
              <label for="ttl">Tempat / Tanggal Lahir</label>
              <input id="ttl" placeholder="Contoh: Bandung, 12 Juni 1985" />
            </div>
            <div>
              <label for="jenisKelamin">Jenis Kelamin</label>
              <select id="jenisKelamin">
                <option value="">-- Pilih --</option>
                <option value="Laki-laki">Laki-laki</option>
                <option value="Perempuan">Perempuan</option>
              </select>
            </div>
          </div>

          <label for="pendidikanAkhir">Pendidikan Terakhir</label>
          <input id="pendidikanAkhir" placeholder="Contoh: SMA / D3 / S1" />

          <div class="field-row-2">
            <div>
              <label for="pendFormal">Pendidikan Formal (SD - SMP - SMA - PT)</label>
              <textarea id="pendFormal" placeholder="Contoh: SDN..., SMP..., SMA..., Perguruan Tinggi..."></textarea>
            </div>
            <div>
              <label for="pendNonFormal">Pendidikan Non Formal</label>
              <textarea id="pendNonFormal" placeholder="Pelatihan, kursus, sertifikasi, dll."></textarea>
            </div>
          </div>

          <div class="section-title">Data Pekerjaan</div>
          <div class="field-row-2">
            <div>
              <label for="statusPerkawinan">Status Perkawinan</label>
              <select id="statusPerkawinan">
                <option value="">-- Pilih --</option>
                <option value="Belum Menikah">Belum Menikah</option>
                <option value="Menikah">Menikah</option>
                <option value="Cerai">Cerai</option>
              </select>
            </div>
            <div>
              <label for="lokasiKerja">Lokasi Kerja</label>
              <input id="lokasiKerja" placeholder="Contoh: CMI, NJG, CLL, BTJ, GNH, dll." />
            </div>
          </div>

          <div class="field-row-2">
            <div>
              <label for="posisiKerja">Posisi Kerja Sebagai</label>
              <input id="posisiKerja" placeholder="Contoh: BASIC_TEHNIK, ADMIN, dll." />
            </div>
            <div>
              <label for="divisi">Divisi</label>
              <input id="divisi" placeholder="Contoh: IOAN, PSB, PROJEK, PIC" />
            </div>
          </div>

          <div class="section-title">Alamat Tempat Tinggal (Domisili)</div>
          <label for="alamatDomisili">Alamat</label>
          <input id="alamatDomisili" />

          <div class="field-row-2">
            <div>
              <label for="domKel">Kelurahan / Desa</label>
              <input id="domKel" />
            </div>
            <div>
              <label for="domKec">Kecamatan</label>
              <input id="domKec" />
            </div>
          </div>
          <label for="domKota">Kota / Kabupaten</label>
          <input id="domKota" />

          <div class="section-title">Kontak &amp; Rekening</div>
          <div class="field-row-2">
            <div>
              <label for="noHp">Nomor Handphone</label>
              <input id="noHp" />
            </div>
            <div>
              <label for="email">Alamat Email</label>
              <input id="email" type="email" />
            </div>
          </div>

          <div class="field-row-2">
            <div>
              <label for="noKtp">Nomor KTP</label>
              <input id="noKtp" />
            </div>
            <div>
              <label for="noNpwp">Nomor NPWP</label>
              <input id="noNpwp" />
            </div>
          </div>

          <div class="field-row-2">
            <div>
              <label for="namaIbu">Nama Ibu Kandung</label>
              <input id="namaIbu" />
            </div>
            <div>
              <label for="noRekening">Nomor Rekening</label>
              <input id="noRekening" />
            </div>
          </div>
          <label for="namaBank">Nama Bank</label>
          <input id="namaBank" />

          <div class="section-title">Alamat Sesuai KTP</div>
          <label for="ktpAlamat">Alamat</label>
          <input id="ktpAlamat" />
          <div class="field-row-2">
            <div>
              <label for="ktpKel">Kelurahan</label>
              <input id="ktpKel" />
            </div>
            <div>
              <label for="ktpKec">Kecamatan</label>
              <input id="ktpKec" />
            </div>
          </div>
          <label for="ktpKota">Kota</label>
          <input id="ktpKota" />

          <div class="section-title">BPJS &amp; Keluarga</div>
          <div class="field-row-2">
            <div>
              <label for="bpjsKet">BPJS Ketenagakerjaan</label>
              <input id="bpjsKet" />
            </div>
            <div>
              <label for="bpjsKes">BPJS Kesehatan</label>
              <input id="bpjsKes" />
            </div>
          </div>

          <div class="field-row-2">
            <div>
              <label for="namaPasangan">Nama Istri / Suami</label>
              <input id="namaPasangan" />
            </div>
            <div>
              <label for="bpjsPasangan">Nomor BPJS Istri / Suami</label>
              <input id="bpjsPasangan" />
            </div>
          </div>

          <div class="field-row-2">
            <div>
              <label for="telpKerabat">Nomor Telepon Kerabat</label>
              <input id="telpKerabat" />
            </div>
            <div>
              <label for="dataAnak">Data Anak</label>
              <input id="dataAnak" placeholder="Nama anak & tanggal lahir (jika ada)" />
            </div>
          </div>

          <div class="field-row-2">
            <div>
              <label for="namaFaskes">Nama Faskes</label>
              <input id="namaFaskes" />
            </div>
            <div>
              <label for="noKk">Nomor Kartu Keluarga</label>
              <input id="noKk" />
            </div>
          </div>

          <div class="section-title">Foto Teknisi</div>
          <input id="fotoTeknisi" type="file" accept="image/*" />
          <img id="previewFotoForm" class="preview-small" />

          <div class="section-title">Foto Dokumen (opsional)</div>
          <div class="field-row-2">
            <div>
              <label for="fotoKtp">Foto KTP</label>
              <input id="fotoKtp" type="file" accept="image/*" />
              <img id="previewFotoKtp" class="preview-small" />
            </div>
            <div>
              <label for="fotoNpwp">Foto NPWP</label>
              <input id="fotoNpwp" type="file" accept="image/*" />
              <img id="previewFotoNpwp" class="preview-small" />
            </div>
          </div>

          <div class="field-row-2">
            <div>
              <label for="fotoBpjsKet">Foto BPJS Ketenagakerjaan</label>
              <input id="fotoBpjsKet" type="file" accept="image/*" />
              <img id="previewFotoBpjsKet" class="preview-small" />
            </div>
            <div>
              <label for="fotoBpjsKes">Foto BPJS Kesehatan</label>
              <input id="fotoBpjsKes" type="file" accept="image/*" />
              <img id="previewFotoBpjsKes" class="preview-small" />
            </div>
          </div>

          <div>
            <label for="fotoKk">Foto KK</label>
            <input id="fotoKk" type="file" accept="image/*" />
            <img id="previewFotoKk" class="preview-small" />
          </div>

          <div class="btn-group">
            <button class="btn btn-primary" type="button" onclick="saveBiodata()">üíæ Simpan</button>
            <button class="btn btn-secondary" type="button" onclick="showPreviewBiodata()">üëÄ Preview Biodata</button>
            <button class="btn btn-secondary" type="button" onclick="scrollToForm()">‚úè Edit</button>
            <button class="btn btn-danger" type="button" onclick="logoutTeknisi()">üö™ Logout</button>
          </div>

          <p id="formStatus" class="status-text"></p>
        </div>
      </div>
    </div>

    <!-- PREVIEW BIODATA (A4) -->
    <div id="previewWrapper" class="biodata-wrapper" style="display:none;">
      <div class="biodata-page" id="biodataPrintArea">
        <div class="biodata-header">
          <h1>BIODATA PEGAWAI</h1>
          <h2>PT. PUTRA TIMUR JAYA</h2>
        </div>

        <div class="biodata-photo-box"><img id="bioFoto" alt="Foto Pegawai" style="display:none" /></div>

        <div class="bio-section">
          <div class="bio-section-title">Data Pribadi</div>
          <table class="bio-table">
            <tr><td class="label">Nama Pegawai</td><td class="value" id="pvNamaPegawai"></td></tr>
            <tr><td class="label">Tempat / Tanggal Lahir</td><td class="value" id="pvTtl"></td></tr>
            <tr><td class="label">Jenis Kelamin</td><td class="value" id="pvJenisKelamin"></td></tr>
            <tr><td class="label">Pendidikan Terakhir</td><td class="value" id="pvPendidikanAkhir"></td></tr>
            <tr><td class="label">Pendidikan Formal</td><td class="value" id="pvPendidikanFormal"></td></tr>
            <tr><td class="label">Pendidikan Non Formal</td><td class="value" id="pvPendidikanNonFormal"></td></tr>
            <tr><td class="label">Foto Pegawai</td><td class="value"><img id="bioFotoInline" alt="Foto Pegawai" style="display:none" /></td></tr>
          </table>
        </div>

        <div class="bio-section">
          <div class="bio-section-title">Data Pekerjaan</div>
          <table class="bio-table">
            <tr><td class="label">Status Perkawinan</td><td class="value" id="pvStatusPerkawinan"></td></tr>
            <tr><td class="label">Lokasi Kerja</td><td class="value" id="pvLokasiKerja"></td></tr>
            <tr><td class="label">Posisi Kerja Sebagai</td><td class="value" id="pvPosisiKerja"></td></tr>
            <tr><td class="label">Divisi</td><td class="value" id="pvDivisi"></td></tr>
          </table>
        </div>

        <div class="bio-section">
          <div class="bio-section-title">Alamat Tempat Tinggal (Domisili)</div>
          <table class="bio-table">
            <tr><td class="label">Alamat</td><td class="value" id="pvAlamatDomisili"></td></tr>
            <tr><td class="label">Kelurahan / Desa</td><td class="value" id="pvDomKel"></td></tr>
            <tr><td class="label">Kecamatan</td><td class="value" id="pvDomKec"></td></tr>
            <tr><td class="label">Kota / Kabupaten</td><td class="value" id="pvDomKota"></td></tr>
          </table>
        </div>

        <div class="bio-section">
          <div class="bio-section-title">Kontak & Rekening</div>
          <table class="bio-table">
            <tr><td class="label">Nomor Handphone</td><td class="value" id="pvNoHp"></td></tr>
            <tr><td class="label">Alamat Email</td><td class="value" id="pvEmail"></td></tr>
            <tr><td class="label">Nomor KTP</td><td class="value" id="pvNoKtp"></td></tr>
            <tr><td class="label">Nomor NPWP</td><td class="value" id="pvNoNpwp"></td></tr>
            <tr><td class="label">Nama Ibu Kandung</td><td class="value" id="pvNamaIbu"></td></tr>
            <tr><td class="label">Nomor Rekening</td><td class="value" id="pvNoRekening"></td></tr>
            <tr><td class="label">Nama Bank</td><td class="value" id="pvNamaBank"></td></tr>
          </table>
        </div>

        <div class="bio-section">
          <div class="bio-section-title">Alamat Sesuai KTP</div>
          <table class="bio-table">
            <tr><td class="label">Alamat</td><td class="value" id="pvKtpAlamat"></td></tr>
            <tr><td class="label">Kelurahan</td><td class="value" id="pvKtpKel"></td></tr>
            <tr><td class="label">Kecamatan</td><td class="value" id="pvKtpKec"></td></tr>
            <tr><td class="label">Kota</td><td class="value" id="pvKtpKota"></td></tr>
          </table>
        </div>

        <div class="bio-section">
          <div class="bio-section-title">BPJS & Keluarga</div>
          <table class="bio-table">
            <tr><td class="label">BPJS Ketenagakerjaan</td><td class="value" id="pvBpjsKet"></td></tr>
            <tr><td class="label">BPJS Kesehatan</td><td class="value" id="pvBpjsKes"></td></tr>
            <tr><td class="label">Nama Istri / Suami</td><td class="value" id="pvNamaPasangan"></td></tr>
            <tr><td class="label">Nomor BPJS Istri / Suami</td><td class="value" id="pvBpjsPasangan"></td></tr>
            <tr><td class="label">Nomor Telepon Kerabat</td><td class="value" id="pvTelpKerabat"></td></tr>
            <tr><td class="label">Data Anak</td><td class="value" id="pvDataAnak"></td></tr>
            <tr><td class="label">Nama Faskes</td><td class="value" id="pvNamaFaskes"></td></tr>
            <tr><td class="label">Nomor Kartu Keluarga</td><td class="value" id="pvNoKk"></td></tr>
          </table>
        </div>

        <div class="bio-section">
          <div class="bio-section-title">Foto Dokumen</div>
          <table class="bio-table">
            <tr><td class="label">KTP</td><td class="value"><img id="bioFotoKtp" alt="Foto KTP" style="display:none" /></td></tr>
            <tr><td class="label">NPWP</td><td class="value"><img id="bioFotoNpwp" alt="Foto NPWP" style="display:none" /></td></tr>
            <tr><td class="label">BPJS Ketenagakerjaan</td><td class="value"><img id="bioFotoBpjsKet" alt="Foto BPJS Ketenagakerjaan" style="display:none" /></td></tr>
            <tr><td class="label">BPJS Kesehatan</td><td class="value"><img id="bioFotoBpjsKes" alt="Foto BPJS Kesehatan" style="display:none" /></td></tr>
            <tr><td class="label">KK</td><td class="value"><img id="bioFotoKk" alt="Foto KK" style="display:none" /></td></tr>
          </table>
        </div>

        <div class="biodata-footer-page">
          Dicetak pada: <span id="pvPrintedAt"></span>
        </div>
      </div>

      <div style="margin-top:10px;text-align:right;">
        <button type="button" class="btn btn-primary" onclick="window.print()">üñ® Cetak / PDF</button>
      </div>

      <div style="margin-top:8px;text-align:right;">
        <a id="sheetLink" class="btn btn-secondary" style="margin-right:6px;" target="_blank">üìÑ Buka Google Sheet</a>
        <a id="driveLink" class="btn btn-secondary" target="_blank">üóÇ Buka Folder Google Drive</a>
        <div style="margin-top:4px;font-size:10px;color:#9ca3af;">*Link hanya untuk admin / pengelola data.</div>
      </div>
    </div>
  </main>

  <script>
    /* ====== CONFIG - ganti WEB_APP_URL kalau perlu ====== */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzfYMYq83BYCNxITAK-CbGQ0uA5diRWuFw1-kyd7zzqmcFR_3hwWnHtNNDLTF4mUHc/exec";
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/1uACE2nd-2E8CNtG-nQUiTUd4x5C2sFfKdZJeb1D_sbM/edit";
    const DRIVE_FOLDER_URL = "https://drive.google.com/drive/folders/1xW5TQYUgpHRbFTdL8nFIxAQA9aJfP7uK?usp=drive_link";

    // user lines (tetap seperti file-mu)
    const USER_LINES = [
      "PTJ_Arip007|alvaro007|15889311|ARIP RAHMATULLOH|PIC|CMI",
      "PTJ_15889310|30223023|15889310|UUS SETIADI|PIC|BTJ",
      "PTJ_Bob1990|TE1990|BELUM ADA|ASEP SAEPUDIN|PIC|CMI",
      // ... (isi semua seperti milikmu)
      "PTJ_ADITTIYA08|80621|16013886|ADITTIYA HERDI|PSB|CMI"
    ];

    // build USERS array
    let USERS = [];
    USER_LINES.forEach(line => {
      const [username,password,nik,nama,divisi,defaultArea] = (line||"").split("|");
      USERS.push({ username: (username||"").toString().trim(), password: (password||"").toString(), nik, nama, divisi, defaultArea });
    });

    let currentUser = null;
    let fotoDataUrl = "", fotoKtpDataUrl = "", fotoKkDataUrl = "", fotoNpwpDataUrl = "", fotoBpjsKetDataUrl = "", fotoBpjsKesDataUrl = "";

    // set admin links
    (function setAdminLinks(){
      const s = document.getElementById("sheetLink");
      const d = document.getElementById("driveLink");
      if (s) s.href = SHEET_URL;
      if (d) d.href = DRIVE_FOLDER_URL;
    })();

    /* ===== LOGIN / LOGOUT ===== */
    function loginTeknisi() {
      const userId = document.getElementById("loginUser").value.trim();
      const pass  = document.getElementById("loginPass").value.trim();
      const statusEl = document.getElementById("loginStatus");

      const user = USERS.find(u => u.username === userId && u.password === pass);
      if (!user) {
        statusEl.textContent = "Login gagal: user ID atau password salah.";
        statusEl.style.color = "#fca5a5";
        return;
      }

      currentUser = user;
      statusEl.textContent = "Login berhasil sebagai " + user.nama + ". Silakan isi biodata.";
      statusEl.style.color = "#bbf7d0";

      document.getElementById("namaPegawai").value = user.nama || "";
      document.getElementById("divisi").value = user.divisi || "";
      document.getElementById("lokasiKerja").value = user.defaultArea || "";

      document.getElementById("formCard").style.display = "block";
      document.getElementById("formCard").scrollIntoView({behavior:"smooth"});
    }

    function logoutTeknisi() {
      currentUser = null;
      document.getElementById("loginUser").value = "";
      document.getElementById("loginPass").value = "";
      document.getElementById("loginStatus").textContent = "";
      document.getElementById("formCard").style.display = "none";
      document.getElementById("previewWrapper").style.display = "none";
      document.getElementById("formStatus").textContent = "";
    }

    function scrollToForm() {
      const f = document.getElementById("formCard");
      if (f) f.scrollIntoView({behavior:"smooth"});
    }

    /* ===== File input previews ===== */
    function attachFilePreview(inputId, imgId, setter) {
      const input = document.getElementById(inputId);
      const img   = document.getElementById(imgId);
      if (!input || !img) return;
      input.addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          const url = ev.target.result;
          setter(url);
          img.src = url;
          img.style.display = "block";
        };
        reader.readAsDataURL(file);
      });
    }

    attachFilePreview("fotoTeknisi", "previewFotoForm", url => fotoDataUrl = url);
    attachFilePreview("fotoKtp", "previewFotoKtp", url => fotoKtpDataUrl = url);
    attachFilePreview("fotoKk", "previewFotoKk", url => fotoKkDataUrl = url);
    attachFilePreview("fotoNpwp", "previewFotoNpwp", url => fotoNpwpDataUrl = url);
    attachFilePreview("fotoBpjsKet", "previewFotoBpjsKet", url => fotoBpjsKetDataUrl = url);
    attachFilePreview("fotoBpjsKes", "previewFotoBpjsKes", url => fotoBpjsKesDataUrl = url);

    /* ===== Collect form data ===== */
    function collectFormData() {
      const get = id => document.getElementById(id)?.value || "";
      return {
        namaPegawai: get("namaPegawai"),
        ttl: get("ttl"),
        jenisKelamin: get("jenisKelamin"),
        pendidikanAkhir: get("pendidikanAkhir"),
        pendFormal: get("pendFormal"),
        pendNonFormal: get("pendNonFormal"),
        statusPerkawinan: get("statusPerkawinan"),
        lokasiKerja: get("lokasiKerja"),
        posisiKerja: get("posisiKerja"),
        divisi: get("divisi"),
        alamatDomisili: get("alamatDomisili"),
        domKel: get("domKel"),
        domKec: get("domKec"),
        domKota: get("domKota"),
        noHp: get("noHp"),
        email: get("email"),
        noKtp: get("noKtp"),
        noNpwp: get("noNpwp"),
        namaIbu: get("namaIbu"),
        noRekening: get("noRekening"),
        namaBank: get("namaBank"),
        ktpAlamat: get("ktpAlamat"),
        ktpKel: get("ktpKel"),
        ktpKec: get("ktpKec"),
        ktpKota: get("ktpKota"),
        bpjsKet: get("bpjsKet"),
        bpjsKes: get("bpjsKes"),
        namaPasangan: get("namaPasangan"),
        bpjsPasangan: get("bpjsPasangan"),
        telpKerabat: get("telpKerabat"),
        dataAnak: get("dataAnak"),
        namaFaskes: get("namaFaskes"),
        noKk: get("noKk")
      };
    }

    /* ===== Save biodata to server ===== */
    async function saveBiodata() {
      if (!currentUser) { alert("Silakan login terlebih dahulu."); return; }
      const statusEl = document.getElementById("formStatus");
      statusEl.style.color = "#9ca3af";
      statusEl.textContent = "Menyimpan biodata ke Google Sheet...";

      const data = collectFormData();
      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({
            mode: "saveBiodata",
            user: currentUser,
            biodata: data,
            foto: fotoDataUrl,
            fotoKtp: fotoKtpDataUrl,
            fotoKk: fotoKkDataUrl,
            fotoNpwp: fotoNpwpDataUrl,
            fotoBpjsKet: fotoBpjsKetDataUrl,
            fotoBpjsKes: fotoBpjsKesDataUrl
          })
        });
        const text = await res.text();
        statusEl.style.color = "#bbf7d0";
        statusEl.textContent = "Biodata berhasil dikirim. Respon server: " + text;
        console.log("Respon server:", text);
      } catch (err) {
        statusEl.style.color = "#fca5a5";
        statusEl.textContent = "Gagal menyimpan biodata: " + (err && err.message ? err.message : err);
        console.error("Error fetch:", err);
      }
    }

   async function showPreviewBiodata() {
  const statusEl = document.getElementById("formStatus");
  statusEl.textContent = "Menyiapkan preview...";
  statusEl.style.color = "#9ca3af";

  let primary = collectFormData();
  let photos = {};

  if (currentUser && currentUser.username) {
    try {
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          mode: "getBiodata",
          username: currentUser.username.toString().trim()
        })
      });

      const j = await res.json();

      if (j && j.ok && j.found) {
        primary = j.biodata || primary;
        photos  = j.photos  || {};
        statusEl.textContent = "Preview menampilkan data tersimpan di server (primary).";
        statusEl.style.color = "#bbf7d0";
      } else {
        statusEl.textContent = "Data belum tersimpan, preview dari form.";
        statusEl.style.color = "#f59e0b";
      }
    } catch (err) {
      console.error("Preview fetch error:", err);
      statusEl.textContent = "Gagal ambil server, preview dari form.";
      statusEl.style.color = "#f59e0b";
    }
  }

  /* ===== ISI TEXT ===== */
  const fill = (id, v) => document.getElementById(id).textContent = v || "-";

  fill("pvNamaPegawai", primary.namaPegawai);
  fill("pvTtl", primary.ttl);
  fill("pvJenisKelamin", primary.jenisKelamin);
  fill("pvPendidikanAkhir", primary.pendidikanAkhir);
  fill("pvPendidikanFormal", primary.pendFormal);
  fill("pvPendidikanNonFormal", primary.pendNonFormal);

  fill("pvStatusPerkawinan", primary.statusPerkawinan);
  fill("pvLokasiKerja", primary.lokasiKerja);
  fill("pvPosisiKerja", primary.posisiKerja);
  fill("pvDivisi", primary.divisi);

  fill("pvAlamatDomisili", primary.alamatDomisili);
  fill("pvDomKel", primary.domKel);
  fill("pvDomKec", primary.domKec);
  fill("pvDomKota", primary.domKota);

  fill("pvNoHp", primary.noHp);
  fill("pvEmail", primary.email);
  fill("pvNoKtp", primary.noKtp);
  fill("pvNoNpwp", primary.noNpwp);
  fill("pvNamaIbu", primary.namaIbu);
  fill("pvNoRekening", primary.noRekening);
  fill("pvNamaBank", primary.namaBank);

  fill("pvKtpAlamat", primary.ktpAlamat);
  fill("pvKtpKel", primary.ktpKel);
  fill("pvKtpKec", primary.ktpKec);
  fill("pvKtpKota", primary.ktpKota);

  fill("pvBpjsKet", primary.bpjsKet);
  fill("pvBpjsKes", primary.bpjsKes);
  fill("pvNamaPasangan", primary.namaPasangan);
  fill("pvBpjsPasangan", primary.bpjsPasangan);
  fill("pvTelpKerabat", primary.telpKerabat);
  fill("pvDataAnak", primary.dataAnak);
  fill("pvNamaFaskes", primary.namaFaskes);
  fill("pvNoKk", primary.noKk);

      /* ===== FOTO ===== */
      const setImg = (id, url) => {
          const img = document.getElementById(id);
          if (img && url) {
            img.src = url;
            img.style.display = "block";
          }
        };

        setImg("bioFotoInline", photos.fotoTeknisi);
        setImg("bioFotoKtp", photos.fotoKtp);
        setImg("bioFotoNpwp", photos.fotoNpwp);
         setImg("bioFotoBpjsKet", photos.fotoBpjsKet);
        setImg("bioFotoBpjsKes", photos.fotoBpjsKes);
        setImg("bioFotoKk", photos.fotoKk);

        document.getElementById("pvPrintedAt").textContent =
        new Date().toLocaleString("id-ID");

        document.getElementById("previewWrapper").style.display = "block";
        document.getElementById("previewWrapper").scrollIntoView({ behavior: "smooth" });
      }

        // photos priority: server -> local dataUrl -> preview img
        const photosServer = (serverData && serverData.photos) ? serverData.photos : null;

        function pick(serverUrl, localUrl, previewElId) {
          if (serverUrl) return normalizeDriveUrlClient(serverUrl);
          if (localUrl) return localUrl;
          const p = document.getElementById(previewElId);
          if (p && p.src) return p.src;
          return "";
        }

        const srcFotoMain = pick(photosServer?.fotoTeknisi, fotoDataUrl, "previewFotoForm");
        const srcKtp = pick(photosServer?.fotoKtp, fotoKtpDataUrl, "previewFotoKtp");
        const srcNpwp = pick(photosServer?.fotoNpwp, fotoNpwpDataUrl, "previewFotoNpwp");
        const srcBpjsKet = pick(photosServer?.fotoBpjsKet, fotoBpjsKetDataUrl, "previewFotoBpjsKet");
        const srcBpjsKes = pick(photosServer?.fotoBpjsKes, fotoBpjsKesDataUrl, "previewFotoBpjsKes");
        const srcKk = pick(photosServer?.fotoKk, fotoKkDataUrl, "previewFotoKk");

        const images = [
          ["bioFotoInline", srcFotoMain],
          ["bioFotoKtp", srcKtp],
          ["bioFotoNpwp", srcNpwp],
          ["bioFotoBpjsKet", srcBpjsKet],
          ["bioFotoBpjsKes", srcBpjsKes],
          ["bioFotoKk", srcKk],
          ["bioFoto", srcFotoMain]
        ];
        images.forEach(pair => {
          const id = pair[0], url = pair[1];
          const el = document.getElementById(id);
          if (!el) return;
          if (url) {
            el.src = url;
            el.style.display = "";
          } else {
            el.removeAttribute("src");
            el.style.display = "none";
          }
        });

        document.getElementById("pvPrintedAt").textContent =
          new Date().toLocaleString("id-ID", {dateStyle:"short", timeStyle:"short"});

        const wrapper = document.getElementById("previewWrapper");
        if (wrapper) wrapper.style.display = "block";
        if (wrapper) wrapper.scrollIntoView({behavior:"smooth"});

        if (serverData) {
          statusEl.textContent = "Preview menampilkan data tersimpan di server (primary).";
          statusEl.style.color = "#bbf7d0";
        } else {
          statusEl.textContent = "Preview berdasarkan isi formulir (data belum tersimpan).";
          statusEl.style.color = "#f59e0b";
        }
      } catch(err) {
        console.error("showPreviewBiodata error:", err);
        const statusEl = document.getElementById("formStatus");
        statusEl.style.color = "#fca5a5";
        statusEl.textContent = "Gagal menyiapkan preview: " + (err && err.message ? err.message : err);
      }
    }
  </script>
</body>
</html>

